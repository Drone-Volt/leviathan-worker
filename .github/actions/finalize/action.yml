# https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: 'Push to balenaMachine on successful release'
description: 'Custom publish step to push releases on balenaMachine after merge'
# these inputs are always provided by flowzone, so they must always be defined on the composite action
inputs:
  json:
    description: 'JSON stringified object containing all the inputs from the calling workflow'
    required: true
  secrets:
    description: 'JSON stringified object containing all the secrets from the calling workflow'
    required: true
  variables:
    description: "JSON stringified object containing all the variables from the calling workflow"
    required: true

runs:
  using: 'composite'
  steps:
    - name: Dump context
      shell: bash
      env:
        GITHUB: ${{ toJSON(github) }}
        INPUTS: ${{ inputs.json }}
        SECRETS: ${{ inputs.secrets }}
        VARIABLES: ${{ toJSON(inputs.variables) }}
      run: |
        echo "${GITHUB}"
        echo "${INPUTS}"
        echo "${SECRETS}"
        echo "${VARIABLES}"

    - name: Describe git state
      id: git_describe
      shell: bash
      run: |
        describe="$(git describe HEAD --tags --always)"
        semver="$(npx -q -y -- semver -c -l "${describe}")"
        echo "semver=${semver}" >> $GITHUB_OUTPUT

    - name: Update balenaMachine docker-compose.yml
      id: update-compose
      shell: bash
      run: |
        sed -r 's|build: .|image: bh\.cr/balena/leviathan-worker-${BALENA_ARCH:-amd64}/${{ steps.git_describe.outputs.semver }} |' -i docker-compose.yml
        cat docker-compose.yml
        sleep 30

    - name: Deploy to balenaMachine
      uses: balena-io/deploy-to-balena-action@master
      with:
        balena_token: ${{ fromJSON(inputs.secrets).BALENAMACHINE_API_KEY }}
        fleet: balena/testbot-rig
        environment: 'bm.balena-dev.com'
        debug: true 
        source: .
